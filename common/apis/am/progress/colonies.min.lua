local a=require("cc.expect")require(settings.get("ghu.base").."core/apis/ghu")local b=require("am.ui.base").BaseObject;local c=require("am.ui")local d=require("am.event")local e=require("am.log")local f=require("am.progress.base")local g=b:extend("am.progress.ColonyProgress")function g:init(h)g.super.init(self)self.id=h;self.status=nil;return self end;local i=f:extend("am.progress.QuarryWrapper")function i:init(j,h,k)i.super.init(self,j,g(h),k)self.names={[d.c.Event.Colonies.status_poll]=true}return self end;function i:createMainTab(l)local m=self.screen.id;local n=l:getTab(1)local o=3;local p=1;n:add(c.Text(c.a.Left(p),"Raid"))n:add(c.Text(c.a.Right(p,o),"",{id=m..".raid"}))p=p+1;n:add(c.Text(c.a.Left(p),"Happiness"))n:add(c.Text(c.a.Right(p,o),"",{id=m..".happiness"}))p=p+1;n:add(c.Text(c.a.Left(p),"Citizens"))n:add(c.Text(c.a.Right(p,o),"/",{id=m..".citizens"}))local q=c.Button(c.a.Right(p),"\x17",{id=m..".citizenTabButton",fillColor=colors.blue,textColor=colors.white,border=0})q:addActivateHandler(function()e.debug("Open Citizens")l:setActive(2)end)n:add(q)p=p+1;n:add(c.Text(c.a.Left(p),"Graves"))n:add(c.Text(c.a.Right(p,o),"",{id=m..".graves"}))p=p+1;n:add(c.Text(c.a.Left(p),"Contructions"))n:add(c.Text(c.a.Right(p,o),"",{id=m..".contructions"}))p=p+1;n:add(c.Text(c.a.Left(p),"Requests"))n:add(c.Text(c.a.Right(p,o),"",{id=m..".requests"}))p=p+1;n:add(c.Text(c.a.Left(p),"Buildings"))n:add(c.Text(c.a.Right(p,o),"",{id=m..".buildings"}))p=p+1;n:add(c.Text(c.a.Left(p),"Visitors"))n:add(c.Text(c.a.Right(p,o),"",{id=m..".visitors"}))p=p+1;n:add(c.Text(c.a.Left(p),"Players"))n:add(c.Text(c.a.Right(p,o),"",{id=m..".players"}))end;function i:createCitizensTab(l,r)local m=self.screen.id;local n=l:createTab("citizens")n:add(c.Text(c.a.TopLeft(),"Citizens"))local s=c.Button(c.a.TopRight(),"x",{id=m..".citizenCloseButton",fillColor=colors.red,border=0})s:addActivateHandler(function()l:setActive(1)end)n:add(s)local t=c.Frame(c.a.Anchor(1,2),{id=m..".citizenListFrame",fillColor=colors.lightGray,textColor=colors.black,fillHorizontal=true,scrollBar=true,height=r-1,border=0})t:add(c.Text(c.a.TopLeft(),"",{id=m..".citizenList"}))n:add(t)end;function i:createUI()local m=self.screen.id;local u,r=self.screen.output.getSize()local v=r-2;self.screen:add(c.Text(c.a.Top(),"",{id=m..".titleText"}))if _G.RUN_PROGRESS and c.h.isTerm(self.screen.output)then local s=c.Button(c.a.TopRight(),"x",{id=m..".closeButton",fillColor=colors.red,border=0})s:addActivateHandler(function()_G.RUN_PROGRESS=false end)self.screen:add(s)end;local l=c.TabbedFrame(c.a.Anchor(1,3),{id=m..".tabsBase",fillColor=colors.black,border=0,fillVertical=true,fillHorizontal=true})local w=l:bind(self.screen.output)self:createMainTab(w)self:createCitizensTab(w,v)w:setActive(1)self.screen:add(l)i.super.createUI(self)end;function i:updateMainTab(l)local x=self.progress.status;local m=self.screen.id;local n=l:getTab(1)local y=n:get(m..".raid")if x.raid then y.obj.textColor=colors.red;y:update("Yes")else y.obj.textColor=colors.green;y:update("No")end;local z=n:get(m..".happiness")if x.happiness<5 then z.obj.textColor=colors.red elseif x.happiness<8 then z.obj.textColor=colors.yellow else z.obj.textColor=colors.green end;z:update(string.format("%d/10",self.progress.status.happiness))local A=n:get(m..".citizens")local B=x.tavernCount*4;local C=x.maxCitizens-B;if x.citizenCount==C then A.obj.textColor=colors.green elseif x.citizenCount>x.maxCitizens then A.obj.textColor=colors.red else A.obj.textColor=colors.yellow end;A:update(string.format("%d/%d",x.citizenCount,x.maxCitizens))local D=n:get(m..".graves")if x.graves>0 then D.obj.textColor=colors.red else D.obj.textColor=colors.green end;D:update(tostring(x.graves))local E=n:get(m..".contructions")E:update(tostring(x.constructionCount))local F=n:get(m..".requests")if#x.requests>0 then F.obj.textColor=colors.yellow else F.obj.textColor=colors.green end;F:update(tostring(#x.requests))local G=n:get(m..".buildings")G:update(tostring(#x.buildings))local H=n:get(m..".visitors")H:update(tostring(x.visitorCount))local I=n:get(m..".players")I:update(tostring(#x.players))end;function i:updateCitizensTab(l,r)local x=self.progress.status;local m=self.screen.id;local n=l:getTab(2)local t=n:get(m..".citizenListFrame")local J=math.max(r-1,x.citizenCount)if t.obj.height~=J then t.obj.height=J;t:render()end;local K=n:get(m..".citizenList")local L={}for u,M in pairs(x.citizens)do local N="Unemployed"if M.work~=nil then N=string.gsub(M.work.type,"^%l",string.upper)end;L[#L+1]=string.format("%s %s",N,M.name)end;K:update(L)end;function i:update(O)local u,r=self.screen.output.getSize()if O.name==d.c.Event.Colonies.status_poll then self.progress.status=O.status end;local P=self.screen:get(self.screen.id..".titleText")P:update(self.progress.status.name)local l=self.screen:get(self.screen.id..".tabsBase")self:updateMainTab(l)self:updateCitizensTab(l,r)end;function i:updateStatus(x)end;function i:handle(O,Q)if O==d.c.Event.Colonies.status_poll then self:update(Q[1])else if O=="monitor_touch"or O=="mouse_click"or O=="ui.frame_touch"then e.debug(string.format("wrapper %s",e.format({O,table.unpack(Q)})))end;self.screen:handle({O,table.unpack(Q)})end end;return i
