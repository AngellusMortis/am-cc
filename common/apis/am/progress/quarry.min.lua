local a=require("cc.expect")require(settings.get("ghu.base").."core/apis/ghu")local b=require("am.ui.base").BaseObject;local c=require("am.ui")local d=require("am.event")local e=require("am.log")local f=require("am.progress.helpers")local g=require("am.progress.base")local h=g:extend("am.progress.QuarryWrapper")function h:init(i,j,k)h.super.init(self,i,j,k)self.paused=false;self.names[j.name]=true;return self end;function h:createUI()local l=self;local m=self.screen.id;local n=2;local o=c.Text(c.a.Top(),"",{id=m..".nameText"})local p,q=self.screen.output.getSize()if q<=12 then n=1;o.visible=false end;if _G.RUN_PROGRESS and c.h.isTerm(self.screen.output)then local r=c.Button(c.a.TopRight(),"x",{id=m..".closeButton",fillColor=colors.red,border=0})r:addActivateHandler(function()_G.RUN_PROGRESS=false end)self.screen:add(r)end;self.screen:add(o)self.screen:add(c.Text(c.a.Center(n),"",{id=m..".titleText"}))local s=c.Frame(c.a.Anchor(1,n+1),{id=m..".progressFrame",fillHorizontal=true,fillVertical=true,border=0,fillColor=colors.black,textColor=colors.white})self.screen:add(s)s:add(c.ProgressBar(c.a.TopLeft(),{id=m..".totalBar",label="Total",displayTotal=self.progress.job.levels,fillColor=colors.lightGray}))s:add(c.ProgressBar(c.a.Left(4),{id=m..".levelBar",label="Level",total=1,fillColor=colors.lightGray}))s:add(c.Text(c.a.Center(7),"",{id=m..".statusText"}))local t=c.Button(c.a.Center(8,c.c.Offset.Left,3),"\x8f",{id=m..".haltButton",fillColor=colors.red})t:addActivateHandler(function()e.info(string.format("Halting %s...",self.src.label))d.TurtleRequestHaltEvent(self.src.id):send()end)local u=c.Button(c.a.Center(8,c.c.Offset.Right,1),"\x95\x95",{id=m..".pauseButton",fillColor=colors.yellow})u:addActivateHandler(function()if l.paused then e.info(string.format("Continuing %s...",self.src.label))d.TurtleRequestContinueEvent(self.src.id):send()else e.info(string.format("Pausing %s...",self.src.label))d.TurtleRequestPauseEvent(self.src.id):send()end end)s:add(t)s:add(u)s:add(c.Text(c.a.Bottom(),"",{id=m..".posText"}))local v=c.Frame(c.a.Anchor(1,n+1),{id=m..".itemsFrame",fillHorizontal=true,fillVertical=true,border=0,fillColor=colors.black,textColor=colors.white})v:add(c.Text(c.a.TopLeft(),"Mined Items",{id=m..".itemsTitle"}))local w=c.Button(c.a.TopRight(),"x",{id=m..".closeItemsButton",fillColor=colors.red,border=0})w:addActivateHandler(function()s:setVisible(true)v:setVisible(false)l.screen:render()end)v:add(w)local x=c.Frame(c.a.Anchor(1,2),{id=m..".itemsListFrame",fillHorizontal=true,border=0,padLeft=1,padTop=1,fillColor=colors.lightGray,textColor=colors.black,scrollBar=true,height=q-n})x:add(c.Text(c.a.TopLeft(),{},{id=m..".itemListText"}))v:add(x)v:setVisible(false)self.screen:add(v)local y=c.Button(c.a.Center(8),"\x17",{id=m..".itemsButton",fillColor=colors.blue})y:addActivateHandler(function()x.currentScroll=0;s:setVisible(false)v:setVisible(true)l.screen:render()end)s:add(y)h.super.createUI(self)end;function h:update(z)local p,q=self.screen.output.getSize()local m=self.screen.id;self.progress=z;local s=self.screen:get(m..".progressFrame")local x=self.screen:get(m..".itemsListFrame")local o=self.screen:get(m..".nameText")local A=self.screen:get(m..".titleText")local B=s:get(m..".totalBar")local C=s:get(m..".levelBar")local D=s:get(m..".statusText")local E=s:get(m..".posText")local F=x:get(m..".itemListText")if self.src.label~=nil then local G=self.src.label;if d.online then G="info:"..G end;o:update(G)end;local n=1;if q<=12 then o.obj.visible=false else n=2;o.obj.visible=true end;A.obj.anchor.y=n;s.obj.anchor.y=n+1;local H=q-n;local I=f.itemStrings(self.progress.progress.items)x.obj.height=math.max(H,#I+2)F:update(I)local J=""if self.progress.job.left~=nil and self.progress.job.forward~=nil then J=string.format(": %d x %d (%d)",self.progress.job.left,self.progress.job.forward,self.progress.job.levels)end;A:update(string.format("Quarry%s",J))B.obj.displayTotal=self.progress.job.levels;B:update(self.progress.progress.current*100)if self.progress.progress.hitBedrock then B:updateLabel("Total (Bedrock)")end;if self.progress.job.left~=nil then C.obj.total=self.progress.job.left end;C:update(self.progress.progress.completedRows)D:update(self.progress.progress.status)local K="pos (%d, %d) e: %d, d: %d"if p<30 then K="(%d,%d) e:%d, d:%d"end;E:update(string.format(K,self.progress.pos.v.x,self.progress.pos.v.z,self.progress.pos.v.y,self.progress.pos.dir))local v=self.screen:get(m..".itemsFrame")v.obj.anchor.y=n+1 end;function h:updateStatus(L)local m=self.screen.id;local D=self.screen:get(m..".statusText")D:update(L)end;function h:handle(z,M)local m=self.screen.id;if z==d.c.Event.Progress.quarry then self:update(M[1])elseif z==d.c.Event.Turtle.paused then self.paused=true;local u=self.screen:get(m..".pauseButton")u.obj.fillColor=colors.green;u:updateLabel("\x10")self.screen:render()elseif z==d.c.Event.Turtle.started then self.paused=false;local s=self.screen:get(m..".progressFrame")local t=s:get(m..".haltButton")local u=s:get(m..".pauseButton")t.obj.visible=s.obj.visible;t:updateLabel("\x8f")u.obj.visible=s.obj.visible;u.obj.fillColor=colors.yellow;u:updateLabel("\x95\x95")self.screen:render()elseif z==d.c.Event.Turtle.exited then local t=self.screen:get(m..".haltButton")local u=self.screen:get(m..".pauseButton")t.obj.visible=false;u.obj.visible=false;self.screen:render()else self.screen:handle({z,table.unpack(M)})end end;return h
