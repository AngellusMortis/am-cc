local a=require("cc.expect")require(settings.get("ghu.base").."core/apis/ghu")local b=require("am.ui.base").BaseObject;local c=require("am.ui")local d=require("am.event")local e=require("am.log")local f=require("am.progress.helpers")local g=require("am.progress.base")local h=g:extend("am.progress.QuarryWrapper")function h:init(i,j,k)h.super.init(self,i,j,k)self.paused=false;self.names[j.name]=true;return self end;function h:createProgressFrame(l)local m=self;local n=l.tabs[1]local o=self.screen.id;local p=c.Button(c.a.Center(8),"\x17",{id=o..".itemsButton",fillColor=colors.blue})p:addActivateHandler(function()l:setActive(m.screen.output,2)end)n:add(p)n:add(c.ProgressBar(c.a.TopLeft(),{id=o..".totalBar",label="Total",displayTotal=self.progress.job.levels,fillColor=colors.lightGray}))n:add(c.ProgressBar(c.a.Left(4),{id=o..".levelBar",label="Level",total=1,fillColor=colors.lightGray}))n:add(c.Text(c.a.Center(7),"",{id=o..".statusText"}))local q=c.Button(c.a.Center(8,c.c.Offset.Left,2),"\x8f",{id=o..".haltButton",fillColor=colors.red})q:addActivateHandler(function()e.info(string.format("Halting %s...",self.src.label))d.TurtleRequestHaltEvent(self.src.id):send()end)n:add(q)local r=c.Button(c.a.Center(8,c.c.Offset.Right,2),"\x95\x95",{id=o..".pauseButton",fillColor=colors.yellow})r:addActivateHandler(function()if m.paused then e.info(string.format("Continuing %s...",self.src.label))d.TurtleRequestContinueEvent(self.src.id):send()else e.info(string.format("Pausing %s...",self.src.label))d.TurtleRequestPauseEvent(self.src.id):send()end end)n:add(r)n:add(c.Text(c.a.Bottom(),"",{id=o..".posText"}))n:setVisible(true)end;function h:createItemsFrame(l,s)local m=self;local o=self.screen.id;local t=l:createTab("items")t.fillHorizontal=true;t.fillVertical=true;t.border=0;t.fillColor=colors.black;t.textColor=colors.white;t:add(c.Text(c.a.TopLeft(),"Mined Items",{id=o..".itemsTitle"}))local u=c.Button(c.a.TopRight(),"x",{id=o..".closeItemsButton",fillColor=colors.red,border=0})u:addActivateHandler(function()l:setActive(m.screen.output,1)end)t:add(u)local v=c.Frame(c.a.Anchor(1,2),{id=o..".itemsListFrame",fillHorizontal=true,border=0,padLeft=1,padTop=1,fillColor=colors.lightGray,textColor=colors.black,scrollBar=true,height=s})v:add(c.Text(c.a.TopLeft(),{},{id=o..".itemListText"}))t:add(v)t:setVisible(false)end;function h:createUI()local o=self.screen.id;local w=2;local x=c.Text(c.a.Top(),"",{id=o..".nameText"})local y,s=self.screen.output.getSize()if s<=12 then w=1;x.visible=false end;if _G.RUN_PROGRESS and c.h.isTerm(self.screen.output)then local z=c.Button(c.a.TopRight(),"x",{id=o..".closeButton",fillColor=colors.red,border=0})z:addActivateHandler(function()_G.RUN_PROGRESS=false end)self.screen:add(z)end;self.screen:add(x)self.screen:add(c.Text(c.a.Center(w),"",{id=o..".titleText"}))local l=c.TabbedFrame(c.a.Anchor(1,w+1),{id=o..".mainFrame",fillHorizontal=true,fillVertical=true,border=0,fillColor=colors.black,textColor=colors.white,primaryTabId="progress"})self:createProgressFrame(l)self:createItemsFrame(l,s-w)l:setActive(self.screen.output,1)self.screen:add(l)h.super.createUI(self)end;function h:update(A)local B,s=self.screen.output.getSize()local o=self.screen.id;self.progress=A;local x=self.screen:get(o..".nameText")local C=self.screen:get(o..".titleText")if self.src.label~=nil then local D=self.src.label;if d.online then D="info:"..D end;x:update(D)end;local w=1;if s<=12 then x.obj.visible=false else w=2;x.obj.visible=true end;local E=""C.obj.anchor.y=w;if self.progress.job.left~=nil and self.progress.job.forward~=nil then E=string.format(": %d x %d (%d)",self.progress.job.left,self.progress.job.forward,self.progress.job.levels)end;C:update(string.format("Quarry%s",E))local l=self.screen:get(o..".mainFrame")local n=l:getTab(1)local F=n:get(o..".totalBar")local G=n:get(o..".levelBar")local H=n:get(o..".statusText")local I=n:get(o..".posText")F.obj.displayTotal=self.progress.job.levels;F:update(self.progress.progress.current*100)if self.progress.progress.hitBedrock then F:updateLabel("Total (Bedrock)")else F:updateLabel("Total")end;if self.progress.job.left~=nil then G.obj.total=self.progress.job.left end;G:update(self.progress.progress.completedRows)H:update(self.progress.progress.status)local J="pos (%d, %d) e: %d, d: %d"if B<30 then J="(%d,%d) e:%d, d:%d"end;I:update(string.format(J,self.progress.pos.v.x,self.progress.pos.v.z,self.progress.pos.v.y,self.progress.pos.dir))n.obj.anchor.y=w+1;local t=l:getTab(2)t.obj.anchor.y=w+1;local v=t:get(o..".itemsListFrame")local K=t:get(o..".itemListText")local L=s-w;local M=f.itemStrings(self.progress.progress.items)v.obj.height=math.max(L,#M+2)K:update(M)end;function h:updateStatus(N)local o=self.screen.id;local H=self.screen:get(o..".statusText")H:update(N)end;function h:handle(A,O)local o=self.screen.id;if A==d.c.Event.Progress.quarry then self:update(O[1])else local l=self.screen:get(o..".mainFrame")local P=l.obj.active==1;local n=l:getTab(1)local q=n:get(o..".haltButton")local r=n:get(o..".pauseButton")if A==d.c.Event.Turtle.paused then self.paused=true;r.obj.fillColor=colors.green;r:updateLabel("\x10")if P then l:render()end elseif A==d.c.Event.Turtle.started then self.paused=false;q.obj.visible=P and true or false;q:updateLabel("\x8f")r.obj.visible=P and true or false;r.obj.fillColor=colors.yellow;r:updateLabel("\x95\x95")if P then l:render()end elseif A==d.c.Event.Turtle.exited then q.obj.visible=false;r.obj.visible=false;if P then l:render()end else self.screen:handle({A,table.unpack(O)})end end end;return h
