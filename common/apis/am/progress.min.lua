local a=require("cc.expect")require(settings.get("ghu.base").."core/apis/ghu")local b=require("am.ui.base").BaseObject;local c=require("am.ui")local d=require("am.event")local e=require("am.log")local f=require("am.core")local g={}local h={}local i=b:extend("am.progress.ProgressWrapper")function i:init(j,k,l)a.expect(1,j,"table")a.expect(2,k,"table")a.expect(3,l,"table")i.super.init(self)self.src=j;self.progress=k;self.screen=c.Screen(l)return self end;function i:createUI()self:update(self.progress)self.screen:render()end;function i:update(m)self.progress=m end;function i:handle(m,n)end;local o=i:extend("am.progress.QuarryWrapper")function o:init(j,k,l)o.super.init(self,j,k,l)self.paused=false;return self end;function o:createUI()local p=self;local q=c.Button(c.a.Center(10,c.c.Offset.Left),"Stop",{id="haltButton",fillColor=colors.red})q:addActivateHandler(function()e.info(string.format("Halting %s...",self.src.label))d.TurtleRequestHaltEvent(self.src.id):send()end)local r=c.Button(c.a.Center(10,c.c.Offset.Right),"Pause",{id="pauseButton",fillColor=colors.yellow})r:addActivateHandler(function()if p.paused then e.info(string.format("Continuing %s...",self.src.label))d.TurtleRequestContinueEvent(self.src.id):send()else e.info(string.format("Pausing %s...",self.src.label))d.TurtleRequestPauseEvent(self.src.id):send()end end)self.screen:add(c.Text(c.a.Top(),"",{id="nameText"}))self.screen:add(c.Text(c.a.Center(2),"",{id="titleText"}))self.screen:add(c.ProgressBar(c.a.Left(3),{id="totalBar",label="Total",displayTotal=self.progress.job.levels,fillColor=colors.lightGray}))self.screen:add(c.ProgressBar(c.a.Left(6),{id="levelBar",label="Level",total=self.progress.job.left,fillColor=colors.lightGray}))self.screen:add(c.Text(c.a.Center(9),"",{id="statusText"}))self.screen:add(q)self.screen:add(r)self.screen:add(c.Text(c.a.Bottom(),"",{id="posText"}))o.super.createUI(self)end;function o:update(m)local s,t=self.screen.output.getSize()self.progress=m;if self.src.label~=nil then local u=self.screen:get("nameText")if u~=nil then local v=self.src.label;if d.online then v="info:"..v end;u:update(v)end end;local w=self.screen:get("titleText")local x=self.screen:get("totalBar")local y=self.screen:get("levelBar")local z=self.screen:get("statusText")local A=self.screen:get("posText")w:update(string.format("Quarry: %d x %d (%d)",self.progress.job.left,self.progress.job.forward,self.progress.job.levels))x:update(self.progress.progress.current)y:update(self.progress.progress.completedRows)z:update(self.progress.progress.status)local B="pos (%d, %d) e: %d, d: %d"if s<30 then B="(%d,%d) e:%d, d:%d"end;A:update(string.format(B,self.progress.pos.v.x,self.progress.pos.v.z,self.progress.pos.v.y,self.progress.pos.dir))end;function o:handle(m,n)if m==d.c.Event.Progress.quarry then self:update(n[1])elseif m==d.c.Event.Turtle.paused then self.paused=true;local r=self.screen:get("pauseButton")r.obj.fillColor=colors.green;r:updateLabel("Go")elseif m==d.c.Event.Turtle.started then self.paused=false;local q=self.screen:get("haltButton")local r=self.screen:get("pauseButton")q.obj.visible=true;q:updateLabel("Stop")r.obj.visible=true;r.obj.fillColor=colors.yellow;r:updateLabel("Pause")elseif m==d.c.Event.Turtle.exited then local q=self.screen:get("haltButton")local r=self.screen:get("pauseButton")q.obj.visible=false;q:updateLabel("")r.obj.visible=false;r:updateLabel("")else self.screen:handle({m,unpack(n)})end end;local function C(j,m,l)a.expect(1,j,"table")a.expect(2,l,"table","nil")a.expect(3,m,"table","nil")local D=l~=nil and m~=nil;if l~=nil then c.h.requireOutput(l)end;local p=h[j.id]local E=false;if D then if p~=nil then if p.event.name~=m.name or not c.h.isSameScreen(p.screen,l)then h[j.id]=nil;p=nil end end;if p==nil then E=true;if m.name==d.c.Event.Progress.quarry then p=o(j,m,l)p:createUI()h[j.id]=p end end end;return p,E end;local function F(j,m,l)a.expect(1,j,"table")a.expect(2,m,"table")a.expect(3,l,"table","nil")if l==nil then l=term else c.h.requireOutput(l)end;local p,E=C(j,m,l)if p~=nil and not E then p:update(m)end end;local function G(j,m,n)local p,E=C(j)if p~=nil then p:handle(m,n)end end;g.print=F;g.handle=G;return g
