local a=require("cc.expect")require(settings.get("ghu.base").."core/apis/ghu")local b=require("am.ui.base").BaseObject;local c=require("am.ui")local d=require("am.event")local e=require("am.log")local f=require("am.core")local g={}local h={}local i=b:extend("am.progress.ProgressWrapper")function i:init(j,k,l)a.expect(1,j,"table")a.expect(2,k,"table")a.expect(3,l,"table")i.super.init(self)self.src=j;self.progress=k;self.screen=c.Screen(l,{id="screen."..j.id})return self end;function i:createUI()self:update(self.progress)self.screen:render()end;function i:update(m)self.progress=m end;function i:updateStatus(n)end;function i:handle(m,o)end;local p=i:extend("am.progress.QuarryWrapper")function p:init(j,k,l)p.super.init(self,j,k,l)self.paused=false;return self end;function p:createUI()local q=self;local r=self.screen.id;local s=2;local t=c.Text(c.a.Top(),"",{id=r..".nameText"})local u,v=self.screen.output.getSize()if v<=12 then s=1;t.visible=false end;local w=c.Button(c.a.Center(s+8,c.c.Offset.Left),"Stop",{id=r..".haltButton",fillColor=colors.red})w:addActivateHandler(function()e.info(string.format("Halting %s...",self.src.label))d.TurtleRequestHaltEvent(self.src.id):send()end)local x=c.Button(c.a.Center(s+8,c.c.Offset.Right),"Pause",{id=r..".pauseButton",fillColor=colors.yellow})x:addActivateHandler(function()if q.paused then e.info(string.format("Continuing %s...",self.src.label))d.TurtleRequestContinueEvent(self.src.id):send()else e.info(string.format("Pausing %s...",self.src.label))d.TurtleRequestPauseEvent(self.src.id):send()end end)self.screen:add(t)self.screen:add(c.Text(c.a.Center(s),"",{id=r..".titleText"}))self.screen:add(c.ProgressBar(c.a.Left(s+1),{id=r..".totalBar",label="Total",displayTotal=self.progress.job.levels,fillColor=colors.lightGray}))self.screen:add(c.ProgressBar(c.a.Left(s+4),{id=r..".levelBar",label="Level",total=1,fillColor=colors.lightGray}))self.screen:add(c.Text(c.a.Center(s+7),"",{id=r..".statusText"}))self.screen:add(w)self.screen:add(x)self.screen:add(c.Text(c.a.Bottom(),"",{id=r..".posText"}))p.super.createUI(self)end;function p:update(m)local y,u=self.screen.output.getSize()local r=self.screen.id;self.progress=m;if self.src.label~=nil then local t=self.screen:get(r..".nameText")if t~=nil then local z=self.src.label;if d.online then z="info:"..z end;t:update(z)end end;local t=self.screen:get(r..".nameText")local A=self.screen:get(r..".titleText")local B=self.screen:get(r..".totalBar")local C=self.screen:get(r..".levelBar")local D=self.screen:get(r..".statusText")local E=self.screen:get(r..".posText")local w=self.screen:get(r..".haltButton")local x=self.screen:get(r..".pauseButton")local u,v=self.screen.output.getSize()local s=1;if v<=12 then t.obj.visible=false else s=2;t.obj.visible=true end;A.obj.anchor.y=s;B.obj.anchor.y=s+1;C.obj.anchor.y=s+4;D.obj.anchor.y=s+7;w.obj.anchor.y=s+8;x.obj.anchor.y=s+8;local F=""if self.progress.job.left~=nil and self.progress.job.forward~=nil then F=string.format(": %d x %d (%d)",self.progress.job.left,self.progress.job.forward,self.progress.job.levels)end;A:update(string.format("Quarry%s",F))B.obj.displayTotal=self.progress.job.levels;B:update(self.progress.progress.current*100)if self.progress.progress.hitBedrock then B:updateLabel("Total (Bedrock)")end;if self.progress.job.left~=nil then C.obj.total=self.progress.job.left end;C:update(self.progress.progress.completedRows)D:update(self.progress.progress.status)local G="pos (%d, %d) e: %d, d: %d"if y<30 then G="(%d,%d) e:%d, d:%d"end;E:update(string.format(G,self.progress.pos.v.x,self.progress.pos.v.z,self.progress.pos.v.y,self.progress.pos.dir))end;function p:updateStatus(n)local r=self.screen.id;local D=self.screen:get(r..".statusText")D:update(n)end;function p:handle(m,o)local r=self.screen.id;if m==d.c.Event.Progress.quarry then self:update(o[1])elseif m==d.c.Event.Turtle.paused then self.paused=true;local x=self.screen:get(r..".pauseButton")x.obj.fillColor=colors.green;x:updateLabel("Go")self.screen:render()elseif m==d.c.Event.Turtle.started then self.paused=false;local w=self.screen:get(r..".haltButton")local x=self.screen:get(r..".pauseButton")w.obj.visible=true;w:updateLabel("Stop")x.obj.visible=true;x.obj.fillColor=colors.yellow;x:updateLabel("Pause")self.screen:render()elseif m==d.c.Event.Turtle.exited then local w=self.screen:get(r..".haltButton")local x=self.screen:get(r..".pauseButton")w.obj.visible=false;x.obj.visible=false;self.screen:render()else self.screen:handle({m,unpack(o)})end end;local function H(I,J)return I.count<J.count end;local function K(I,J)return I.count>J.count end;local function L(M,N)if N==nil then N=false end;local O={}for u,P in pairs(M)do O[#O+1]=P end;if N then table.sort(O,H)else table.sort(O,K)end;local Q={}for u,P in ipairs(O)do Q[#Q+1]=string.format("%dx %s",P.count,P.displayName)end;return Q end;local function R(j,m,l)a.expect(1,j,"table")a.expect(2,l,"table","nil")a.expect(3,m,"table","nil")local S=l~=nil and m~=nil;if l~=nil then c.h.requireOutput(l)end;local q=h[j.id]local T=false;if S then if q~=nil then if q.progress.name~=m.name or not c.h.isSameScreen(q.screen.output,l)then h[j.id]=nil;q=nil end end;if q==nil then T=true;if m.name==d.c.Event.Progress.quarry then q=p(j,m,l)q:createUI()h[j.id]=q end end end;return q,T end;local function U(l)for V,q in pairs(h)do if c.h.isSameScreen(l,q.screen.output)then return{id=V}end end;return nil end;local function W(j,n)a.expect(1,j,"table")a.expect(2,n,"string")local q=R(j)if q~=nil then q:updateStatus(n)end end;local function X(j,m,l)a.expect(1,j,"table")a.expect(2,m,"table")a.expect(3,l,"table","nil")if l==nil then l=term else c.h.requireOutput(l)end;local q,T=R(j,m,l)if q~=nil and not T then q:update(m)end end;local function Y(m,o)for u,q in pairs(h)do q:handle(m,o)end end;local function Z(j,m,o)local _=nil;if c.c.l.Events.Always[m]then Y(m,o)return elseif c.c.l.Events.UI[m]then local a0=f.split(o[1].objId,".")if a0[1]=="screen"then _={id=tonumber(a0[2])}end elseif c.c.l.Events.Terminal[m]then _=U(term)elseif c.c.l.Events.Monitor[m]then _=U(peripheral.wrap(o[1]))end;if _~=nil then j=_ end;local q,u=R(j)if q~=nil then q:handle(m,o)end end;g.updateStatus=W;g.print=X;g.handle=Z;g.itemStrings=L;return g
