require(settings.get("ghu.base").."core/apis/ghu")local a=require("am.core")local b=require("am.ui")local c=peripheral.find("basic_interface")local d=peripheral.find("monitor")local e=require("am.log")if c==nil then error("Could not find Stargate Basic Interface")end;if d==nil then error("Could not find Stargate Dialing Monitor")end;_G.RUNNING=false;_G.CAN_DIAL=false;local f={}local g=nil;local h={}h.allGates={name="sg.allGates",default={},type="table"}h=a.makeSettingWrapper(h)local i=b.Screen(term,{textColor=colors.white,backgroundColor=colors.black})local j=b.Screen(d,{textColor=colors.white,backgroundColor=colors.black})local function k()return _G.CAN_DIAL end;local function l()return _G.RUNNING end;local function m(n)local o=h.allGates.get()for p,address in pairs(o)do if#n==#address.address then local q=true;for r,s in ipairs(address.address)do if s~=n[r]then q=false;break end end;if q then return address end end end;local t="-"for p,s in ipairs(n)do t=t..tostring(s).."-"end;return{id="unknown",name=t,address=address}end;local function u(v)_G.RUNNING=v;if not v then _G.CAN_DIAL=false end end;local function w(x)local y=i:get("termStatus")if y~=nil then y:update(x)end;local z=j:get("dialStatus")if z~=nil then z:update(x)end end;local function A(x,B)local C=i:get("termProgress")local D=false;if C~=nil then if B==nil then C.obj.baseLabel=""C.obj.visible=false;C:update(0)i:render()else C.obj.baseLabel=x;C.obj.visible=true;C:update(B)i:render()end end;local E=j:get("dialProgress")if E~=nil then if B==nil then E.obj.baseLabel=""E.obj.visible=false;E:update(0)j:render()else E.obj.baseLabel=x;E.obj.visible=true;E:update(B)j:render()end end end;local function F(G)c.rotateClockwise(G)while not c.isCurrentSymbol(G)do sleep(1)end end;local function H(I)if I==nil then I=1 end;_G.CAN_DIAL=false;g=nil;w("Resetting Stargate")A("")c.disconnectStargate()if not c.isCurrentSymbol(0)then c.rotateClockwise(-1)if I>0 then sleep(I)end;F(0)end;w("Idle")e.debug("idle")_G.CAN_DIAL=true end;local function J(G)if not k()then return end;F(G)c.raiseChevron()sleep(0.5)c.lowerChevron()end;local function K(address)local L=0;local M=#address.address+1;local N="Dial: "..address.name;e.debug("dial address: "..address.name)w("Dialing")A(N,1)c.disconnectStargate()c.rotateClockwise(-1)sleep(3)if not k()then return end;for p,G in ipairs(address.address)do if k()then J(G)L=L+1;A(N,math.floor(L/M*100))end end;if k()then J(0)A(N,100)end end;local function O(P,Q,R)local address=f[P.id]if address==nil then e.debug("No dial ("..P.id..")")elseif g~=nil then e.debug("Dial already in progress")else g=address;P.fillColor=colors.lightGray;P.disabled=true end end;local function S(T)local U,V=T.output.getSize()T:add(b.Text(b.a.Top(),"Stargate Control",{textColor=colors.cyan}))T:add(b.Text(b.a.Center(3),"",{id="termStatus",textColor=colors.white}))local W=b.ProgressBar(b.a.Left(4),{id="termProgress",label="",textColor=colors.white,border=0,showProgress=false,showCount=false,showPercent=true})W.visible=false;T:add(W)local X=b.Frame(b.a.Left(5),{id="termAddress",width=U-9,height=V-7,backgroundColor=colors.black,fillColor=colors.lightGray,fillHorizontal=false,scrollBar=true,padLeft=1,padTop=1})T:add(X)local Y=b.Button(b.a.BottomLeft(),"Dial",{id="termDial",disabled=true,fillColor=colors.lightGray,width=U-9,backgroundColor=colors.black})Y:addActivateHandler(O)T:add(Y)local Z=b.Button(b.a.BottomRight(),"Exit",{fillColor=colors.red,backgroundColor=colors.black})Z:addActivateHandler(function()u(false)end)T:add(Z)local _=b.Button(b.a.Right(V-5),"Reset",{fillColor=colors.yellow,backgroundColor=colors.black,textColor=colors.black})_:addActivateHandler(function()H()end)T:add(_)end;local function a0(T)local U,V=T.output.getSize()T:add(b.Text(b.a.Top(),"Stargate Dialer",{textColor=colors.cyan}))T:add(b.Text(b.a.Center(3),"",{id="dialStatus",textColor=colors.white}))local W=b.ProgressBar(b.a.Left(4),{id="dialProgress",label="",textColor=colors.white,border=0,showProgress=false,showCount=false,showPercent=true})W.visible=false;T:add(W)local X=b.Frame(b.a.Left(5),{id="dialAddress",width=U,height=V-7,backgroundColor=colors.black,fillColor=colors.lightGray,fillHorizontal=false,scrollBar=true,padLeft=1,padTop=1})T:add(X)local Y=b.Button(b.a.BottomLeft(),"Dial",{id="dialDial",disabled=true,fillColor=colors.lightGray,width=U,backgroundColor=colors.black})Y:addActivateHandler(O)T:add(Y)end;local function a1(a2,a3)return a2.name:lower()<a3.name:lower()end;local function a4(a5,a6)local a7={}for r,address in ipairs(a5)do local U=a6:getWidth()local N="  "..address.name..string.rep(" ",U-address.name:len()-2)local a8=a6.obj.id..address.id;local a9=a6:get(a8)local x;if a9==nil then x=b.Text(b.a.Left(r),N,{id=a8,width=a6:getWidth()})a6.obj:add(x)else x=a9.obj;x.anchor=b.a.Left(r)end;x.label=N;x.backgroundColor=colors.lightGray;x.textColor=colors.black;x.visible=true;a7[N]=true end;for p,aa in pairs(a6.obj.i)do if a7[aa.label]==nil then aa.visible=false end end end;local function ab()local o=h.allGates.get()local a5={}for p,address in pairs(o)do a5[#a5+1]=address end;table.sort(a5,a1)a4(a5,i:get("termAddress"))i:render()a4(a5,j:get("dialAddress"))j:render()end;local function ac(ad,t,address)local o=h.allGates.get()o[ad]={id=ad,name=t,address=address}h.allGates.set(o)ab()end;local function ae(ad)local o=h.allGates.get()o[ad]=nil;h.allGates.set(o)ab()end;local function af()S(i)a0(j)i:render()j:render()end;local function ag(a6,P,ah)e.debug("click ("..a6.obj.id.."): "..ah)e.debug(P.obj.id)local U=a6:getWidth()local o=h.allGates.get()local a5={}for p,address in pairs(o)do a5[#a5+1]=address end;table.sort(a5,a1)local address=a5[ah]if address==nil or g~=nil or not k()then P.obj.fillColor=colors.lightGray;P.obj.disabled=true else P.obj.fillColor=colors.green;P.obj.disabled=false end;if address==nil then f[P.obj.id]=nil;return end;f[P.obj.id]=address;for p,aa in pairs(a6.obj.i)do local N="  "..address.name..string.rep(" ",U-address.name:len()-2)if aa.label==N then aa.backgroundColor=colors.black;aa.textColor=colors.green else aa.backgroundColor=colors.lightGray;aa.textColor=colors.black end end end;local function ai(R,aj)if R:find("^stargate_")then e.debug({R,aj})if R=="stargate_chevron_engaged"then w("Chevron "..aj[1].." Engaged: "..aj[2])elseif R=="stargate_outgoing_wormhole"then address=m(aj[1])w("Outgoing: "..address.name)elseif R=="stargate_incoming_wormhole"then address=m(aj[1])w("Incoming: "..address.name)_G.CAN_DIAL=false elseif R=="stargate_disconnected"then w("Idle")_G.CAN_DIAL=true end elseif R=="terminate"then u(false)else i:handle(R,table.unpack(aj))j:handle(R,table.unpack(aj))if R=="ui.frame_click"and aj[1].objId=="termAddress"then ag(i:get("termAddress"),i:get("termDial"),aj[1].y)i:render()elseif R=="ui.frame_touch"and aj[1].objId=="dialAddress"then ag(j:get("dialAddress"),j:get("dialDial"),aj[1].y)j:render()end end end;local function ak()while l()do local R,aj=a.cleanEventArgs(os.pullEventRaw())ai(R,aj)end end;local function al()H()while l()do if g~=nil then K(g)g=nil end;sleep(1)end end;local function am()u(true)e.s.print.set(false)af()ab()parallel.waitForAll(ak,al)H(0)term.clear()term.setCursorPos(1,1)term.setTextColor(colors.white)end;am()
