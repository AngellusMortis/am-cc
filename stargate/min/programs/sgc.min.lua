require(settings.get("ghu.base").."core/apis/ghu")local a=require("am.core")local b=require("am.ui")local c=peripheral.find("basic_interface")local d=peripheral.find("monitor")local e=require("am.log")if c==nil then error("Could not find Stargate Basic Interface")end;if d==nil then error("Could not find Stargate Dialing Monitor")end;_G.RUNNING=false;_G.CAN_DIAL=false;local f={}local g=nil;local h={}h.allGates={name="sg.allGates",default={},type="table"}h=a.makeSettingWrapper(h)local i=b.Screen(term,{textColor=colors.white,backgroundColor=colors.black})local j=b.Screen(d,{textColor=colors.white,backgroundColor=colors.black})local function k()return _G.CAN_DIAL end;local function l()return _G.RUNNING end;local function m(n)local o=h.allGates.get()for p,address in pairs(o)do if#n==#address.address then local q=true;for r,s in ipairs(address.address)do if s~=n[r]then q=false;break end end;if q then return address end end end;local t="-"for p,s in ipairs(n)do t=t..tostring(s).."-"end;return{id="unknown",name=t,address=address}end;local function u(v)_G.RUNNING=v;if not v then _G.CAN_DIAL=false end end;local function w(x)local y=i:get("termStatus")if y~=nil then y:update(x)end;local z=j:get("dialStatus")if z~=nil then z:update(x)end end;local function A(x,B)local C=i:get("termProgress")if C~=nil then if B==nil then C.obj.baseLabel=""C.obj.visible=false;C:update(0)i:render()else C.obj.baseLabel=x;C.obj.visible=true;C:update(B)end end;local D=j:get("dialProgress")if D~=nil then if B==nil then D.obj.baseLabel=""D.obj.visible=false;D:update(0)j:render()else D.obj.baseLabel=x;D.obj.visible=true;D:update(B)end end end;local function E(F)c.rotateClockwise(F)while not c.isCurrentSymbol(F)do sleep(1)end end;local function G(H)if H==nil then H=1 end;_G.CAN_DIAL=false;g=nil;w("Resetting Stargate")A("")c.disconnectStargate()if not c.isCurrentSymbol(0)then c.rotateClockwise(-1)if H>0 then sleep(H)end;E(0)end;w("Idle")e.debug("idle")_G.CAN_DIAL=true end;local function I(F)if not k()then return end;E(F)c.raiseChevron()sleep(0.5)c.lowerChevron()end;local function J(address)local K=0;local L=#address.address+1;local M="Dial: "..address.name;e.debug("dial address: "..address.name)w("Dialing")A(M,1)c.disconnectStargate()c.rotateClockwise(-1)sleep(3)if not k()then return end;for p,F in ipairs(address.address)do if k()then I(F)K=K+1;A(M,math.floor(K/L*100))end end;if k()then I(0)A(M,100)end end;local function N(O,P,Q)local address=f[O.id]if address==nil then e.debug("No dial ("..O.id..")")elseif g~=nil then e.debug("Dial already in progress")else g=address;O.fillColor=colors.lightGray;O.disabled=true end end;local function R(S)local T,U=S.output.getSize()S:add(b.Text(b.a.Top(),"Stargate Control",{textColor=colors.cyan}))S:add(b.Text(b.a.Center(3),"",{id="termStatus",textColor=colors.white}))local V=b.ProgressBar(b.a.Left(4),{id="termProgress",label="",textColor=colors.white,border=0,showProgress=false,showCount=false,showPercent=true})V.visible=false;S:add(V)local W=b.Frame(b.a.Left(5),{id="termAddress",width=T-9,height=U-7,backgroundColor=colors.black,fillColor=colors.lightGray,fillHorizontal=false,scrollBar=true,padLeft=1,padTop=1})S:add(W)local X=b.Button(b.a.BottomLeft(),"Dial",{id="termDial",disabled=true,fillColor=colors.lightGray,width=T-9,backgroundColor=colors.black})X:addActivateHandler(N)S:add(X)local Y=b.Button(b.a.BottomRight(),"Exit",{fillColor=colors.red,backgroundColor=colors.black})Y:addActivateHandler(function()u(false)end)S:add(Y)local Z=b.Button(b.a.Right(U-5),"Reset",{fillColor=colors.yellow,backgroundColor=colors.black,textColor=colors.black})Z:addActivateHandler(function()G()end)S:add(Z)end;local function _(S)local T,U=S.output.getSize()S:add(b.Text(b.a.Top(),"Stargate Dialer",{textColor=colors.cyan}))S:add(b.Text(b.a.Center(3),"",{id="dialStatus",textColor=colors.white}))local V=b.ProgressBar(b.a.Left(4),{id="dialProgress",label="",textColor=colors.white,border=0,showProgress=false,showCount=false,showPercent=true})V.visible=false;S:add(V)local W=b.Frame(b.a.Left(5),{id="dialAddress",width=T,height=U-7,backgroundColor=colors.black,fillColor=colors.lightGray,fillHorizontal=false,scrollBar=true,padLeft=1,padTop=1})S:add(W)local X=b.Button(b.a.BottomLeft(),"Dial",{id="dialDial",disabled=true,fillColor=colors.lightGray,width=T,backgroundColor=colors.black})X:addActivateHandler(N)S:add(X)end;local function a0(a1,a2)return a1.name:lower()<a2.name:lower()end;local function a3(a4,a5)local a6={}for r,address in ipairs(a4)do local T=a5:getWidth()local M="  "..address.name..string.rep(" ",T-address.name:len()-2)local a7=a5.obj.id..address.id;local a8=a5:get(a7)local x;if a8==nil then x=b.Text(b.a.Left(r),M,{id=a7,width=a5:getWidth()})a5.obj:add(x)else x=a8.obj;x.anchor=b.a.Left(r)end;x.label=M;x.backgroundColor=colors.lightGray;x.textColor=colors.black;x.visible=true;a6[M]=true end;for p,a9 in pairs(a5.obj.i)do if a6[a9.label]==nil then a9.visible=false end end end;local function aa()local o=h.allGates.get()local a4={}for p,address in pairs(o)do a4[#a4+1]=address end;table.sort(a4,a0)a3(a4,i:get("termAddress"))i:render()a3(a4,j:get("dialAddress"))j:render()end;local function ab(ac,t,address)local o=h.allGates.get()o[ac]={id=ac,name=t,address=address}h.allGates.set(o)aa()end;local function ad(ac)local o=h.allGates.get()o[ac]=nil;h.allGates.set(o)aa()end;local function ae()R(i)_(j)i:render()j:render()end;local function af(a5,O,ag)e.debug("click ("..a5.obj.id.."): "..ag)e.debug(O.obj.id)local T=a5:getWidth()local o=h.allGates.get()local a4={}for p,address in pairs(o)do a4[#a4+1]=address end;table.sort(a4,a0)local address=a4[ag]if address==nil or g~=nil then O.obj.fillColor=colors.lightGray;O.obj.disabled=true else O.obj.fillColor=colors.green;O.obj.disabled=false end;if address==nil then f[O.obj.id]=nil;return end;f[O.obj.id]=address;for p,a9 in pairs(a5.obj.i)do local M="  "..address.name..string.rep(" ",T-address.name:len()-2)if a9.label==M then a9.backgroundColor=colors.black;a9.textColor=colors.green else a9.backgroundColor=colors.lightGray;a9.textColor=colors.black end end end;local function ah(Q,ai)if Q:find("^stargate_")then e.debug({Q,ai})if Q=="stargate_chevron_engaged"then w("Chevron "..ai[1].." Engaged: "..ai[2])elseif Q=="stargate_outgoing_wormhole"then address=m(ai[1])w("Outgoing: "..address.name)elseif Q=="stargate_incoming_wormhole"then address=m(ai[1])w("Incoming: "..address.name)end elseif Q=="terminate"then u(false)else i:handle(Q,table.unpack(ai))j:handle(Q,table.unpack(ai))if Q=="ui.frame_click"and ai[1].objId=="termAddress"then af(i:get("termAddress"),i:get("termDial"),ai[1].y)i:render()elseif Q=="ui.frame_touch"and ai[1].objId=="dialAddress"then af(j:get("dialAddress"),j:get("dialDial"),ai[1].y)j:render()end end end;local function aj()while l()do local Q,ai=a.cleanEventArgs(os.pullEventRaw())ah(Q,ai)end end;local function ak()G()while l()do if g~=nil then J(g)g=nil end;sleep(1)end end;local function al()u(true)e.s.print.set(false)ae()aa()parallel.waitForAll(aj,ak)G(0)term.clear()term.setCursorPos(1,1)term.setTextColor(colors.white)end;al()
