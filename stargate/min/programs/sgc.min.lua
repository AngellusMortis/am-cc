require(settings.get("ghu.base").."core/apis/ghu")local a=require("am.core")local b=require("am.ui")local c=require("am.log")local d=require("cc.audio.dfpwm")local e=peripheral.find("basic_interface")local f=peripheral.find("monitor")local g=peripheral.find("speaker")if e==nil then error("Could not find Stargate Basic Interface")end;if f==nil then error("Could not find Stargate Dialing Monitor")end;_G.RUNNING=false;_G.CAN_DIAL=false;_G.PLAY_ALERT=false;local h={}local i=nil;local j={}j.allGates={name="sg.allGates",default={},type="table"}j=a.makeSettingWrapper(j)local k=b.Screen(term,{textColor=colors.white,backgroundColor=colors.black})local l=b.Screen(f,{textColor=colors.white,backgroundColor=colors.black})local function m()return _G.CAN_DIAL end;local function n()return _G.RUNNING end;local function o()if not _G.PLAY_ALERT then _G.PLAY_ALERT=true end end;local function p()if g==nil then return end;local q=d.make_decoder()for r in io.lines(settings.get("ghu.base").."ext/AngellusMortis/am-cc/stargate/data/alert.dfpwm",16*1024)do local s=q(r)while not g.playAudio(s)do os.pullEvent("speaker_audio_empty")end end end;local function t(u)local v=j.allGates.get()for w,address in pairs(v)do if#u==#address.address then local x=true;for y,z in ipairs(address.address)do if z~=u[y]then x=false;break end end;if x then return address end end end;local A="-"for w,z in ipairs(u)do A=A..tostring(z).."-"end;return{id="unknown",name=A,address=address}end;local function B(C)_G.RUNNING=C;if not C then _G.CAN_DIAL=false end end;local function D(E)local F=k:get("termStatus")if F~=nil then F:update(E)end;local G=l:get("dialStatus")if G~=nil then G:update(E)end end;local function H(E,I)local J=k:get("termProgress")local K=false;if J~=nil then if I==nil then J.obj.baseLabel=""J.obj.visible=false;J:update(0)k:render()else J.obj.baseLabel=E;J.obj.visible=true;J:update(I)k:render()end end;local L=l:get("dialProgress")if L~=nil then if I==nil then L.obj.baseLabel=""L.obj.visible=false;L:update(0)l:render()else L.obj.baseLabel=E;L.obj.visible=true;L:update(I)l:render()end end end;local function M(N)e.rotateClockwise(N)while not e.isCurrentSymbol(N)do sleep(1)end end;local function O(P)if P==nil then P=1 end;_G.CAN_DIAL=false;i=nil;D("Resetting Stargate")H("")e.disconnectStargate()if not e.isCurrentSymbol(0)then e.rotateClockwise(-1)if P>0 then sleep(P)end;M(0)end;D("Idle")c.debug("idle")_G.CAN_DIAL=true end;local function Q(N)if not m()then return end;M(N)e.raiseChevron()sleep(0.5)e.lowerChevron()end;local function R(address)local S=0;local T=#address.address+1;local U="Dial: "..address.name;c.debug("dial address: "..address.name)D("Dialing")H(U,1)e.disconnectStargate()e.rotateClockwise(-1)sleep(3)if not m()then return end;for w,N in ipairs(address.address)do if m()then Q(N)S=S+1;H(U,math.floor(S/T*100))end end;if m()then Q(0)H(U,100)end end;local function V(W,X,Y)local address=h[W.id]if address==nil then c.debug("No dial ("..W.id..")")elseif i~=nil then c.debug("Dial already in progress")else i=address;W.fillColor=colors.lightGray;W.disabled=true end end;local function Z()local _=k:get("dialFrame")if _~=nil then _:setVisible(true)end;local a0=k:get("manualFrame")if a0~=nil then a0:setVisible(false)end;k:render()end;local function a1()local _=k:get("dialFrame")if _~=nil then _:setVisible(false)end;local a0=k:get("manualFrame")if a0~=nil then a0:setVisible(true)end;k:render()end;local function a2(a3)local a4,a5=k.output.getSize()local a6=b.Frame(b.a.TopLeft(),{id="termAddress",width=a4-10,height=a5-7,backgroundColor=colors.black,fillColor=colors.lightGray,fillHorizontal=false,scrollBar=true,padLeft=1,padTop=1})a3:add(a6)local a7=b.Button(b.a.BottomLeft(),"Dial",{id="termDial",disabled=true,fillColor=colors.lightGray,width=a4-10,backgroundColor=colors.black})a7:addActivateHandler(V)a3:add(a7)local a8=b.Button(b.a.BottomRight(),"Exit",{fillColor=colors.red,backgroundColor=colors.black})a8:addActivateHandler(function()B(false)end)a3:add(a8)local a9=b.Button(b.a.Right(a5-9),"Reset",{fillColor=colors.yellow,backgroundColor=colors.black,textColor=colors.black})a9:addActivateHandler(function()O()end)a3:add(a9)local aa=b.Button(b.a.Right(a5-12),"Manual",{id="manualButton",fillColor=colors.blue,backgroundColor=colors.black,textColor=colors.black})aa:addActivateHandler(function()a1()end)a3:add(aa)end;local function ab(a3)local a4,a5=k.output.getSize()local ac=b.Button(b.a.BottomRight(),"Auto",{id="autoButton",fillColor=colors.blue,backgroundColor=colors.black,textColor=colors.black})ac:addActivateHandler(function()Z()end)a3:add(ac)end;local function ad(ae)local a4,a5=ae.output.getSize()ae:add(b.Text(b.a.Top(),"Stargate Control",{textColor=colors.cyan}))ae:add(b.Text(b.a.Center(3),"",{id="termStatus",textColor=colors.white}))local af=b.ProgressBar(b.a.Left(4),{id="termProgress",label="",textColor=colors.white,border=0,showProgress=false,showCount=false,showPercent=true})af.visible=false;ae:add(af)local _=b.Frame(b.a.Left(5),{id="dialFrame",width=a4,height=a5-4,backgroundColor=colors.black,fillColor=colors.black,border=0,fillHorizontal=true,scrollBar=false,padLeft=0,padTop=0})ae:add(_)a2(_)local a0=b.Frame(b.a.Left(5),{id="manualFrame",width=a4,height=a5-4,backgroundColor=colors.black,fillColor=colors.black,border=0,fillHorizontal=true,scrollBar=false,padLeft=0,padTop=0})ae:add(a0)ab(a0)a0:setVisible(false)end;local function ag(ae)local a4,a5=ae.output.getSize()ae:add(b.Text(b.a.Top(),"Stargate Dialer",{textColor=colors.cyan}))ae:add(b.Text(b.a.Center(3),"",{id="dialStatus",textColor=colors.white}))local af=b.ProgressBar(b.a.Left(4),{id="dialProgress",label="",textColor=colors.white,border=0,showProgress=false,showCount=false,showPercent=true})af.visible=false;ae:add(af)local a6=b.Frame(b.a.Left(5),{id="dialAddress",width=a4,height=a5-7,backgroundColor=colors.black,fillColor=colors.lightGray,fillHorizontal=false,scrollBar=true,padLeft=1,padTop=1})ae:add(a6)local a7=b.Button(b.a.BottomLeft(),"Dial",{id="dialDial",disabled=true,fillColor=colors.lightGray,width=a4,backgroundColor=colors.black})a7:addActivateHandler(V)ae:add(a7)end;local function ah(ai,aj)return ai.name:lower()<aj.name:lower()end;local function ak(al,a3)local am={}for y,address in ipairs(al)do local a4=a3:getWidth()local U="  "..address.name..string.rep(" ",a4-address.name:len()-2)local an=a3.obj.id..address.id;local ao=a3:get(an)local E;if ao==nil then E=b.Text(b.a.Left(y),U,{id=an,width=a3:getWidth()})a3.obj:add(E)else E=ao.obj;E.anchor=b.a.Left(y)end;E.label=U;E.backgroundColor=colors.lightGray;E.textColor=colors.black;E.visible=true;am[U]=true end;for w,ap in pairs(a3.obj.i)do if am[ap.label]==nil then ap.visible=false end end end;local function aq()local v=j.allGates.get()local al={}for w,address in pairs(v)do al[#al+1]=address end;table.sort(al,ah)ak(al,k:get("termAddress"))k:render()ak(al,l:get("dialAddress"))l:render()end;local function ar(as,A,address)local v=j.allGates.get()v[as]={id=as,name=A,address=address}j.allGates.set(v)end;local function at(as)local v=j.allGates.get()v[as]=nil;j.allGates.set(v)aq()end;local function au()ad(k)ag(l)k:render()l:render()end;local function av(a3,W,aw)c.debug("click ("..a3.obj.id.."): "..aw)c.debug(W.obj.id)local a4=a3:getWidth()local v=j.allGates.get()local al={}for w,address in pairs(v)do al[#al+1]=address end;table.sort(al,ah)local address=al[aw]if address==nil or i~=nil or not m()then W.obj.fillColor=colors.lightGray;W.obj.disabled=true else W.obj.fillColor=colors.green;W.obj.disabled=false end;if address==nil then h[W.obj.id]=nil;return end;h[W.obj.id]=address;for w,ap in pairs(a3.obj.i)do local U="  "..address.name..string.rep(" ",a4-address.name:len()-2)if ap.label==U then ap.backgroundColor=colors.black;ap.textColor=colors.green else ap.backgroundColor=colors.lightGray;ap.textColor=colors.black end end end;local function ax(Y,ay)if Y:find("^stargate_")then c.debug({Y,ay})if Y=="stargate_chevron_engaged"then D("Chevron "..ay[1].." Engaged: "..ay[2])elseif Y=="stargate_outgoing_wormhole"then local address=t(ay[1])D("Outgoing: "..address.name)H("")elseif Y=="stargate_incoming_wormhole"then local address=t(ay[1])D("Incoming: "..address.name)H("")_G.CAN_DIAL=false;o()elseif Y=="stargate_disconnected"then H("")D("Idle")_G.CAN_DIAL=true end elseif Y=="terminate"then B(false)else k:handle(Y,table.unpack(ay))l:handle(Y,table.unpack(ay))if Y=="ui.frame_click"and ay[1].objId=="termAddress"then av(k:get("termAddress"),k:get("termDial"),ay[1].y)k:render()elseif Y=="ui.frame_touch"and ay[1].objId=="dialAddress"then av(l:get("dialAddress"),l:get("dialDial"),ay[1].y)l:render()end end end;local function az()while n()do local Y,ay=a.cleanEventArgs(os.pullEventRaw())ax(Y,ay)end end;local function aA()O()while n()do if i~=nil then R(i)i=nil end;sleep(0.05)end end;local function aB()if g==nil then return end;while n()do if _G.PLAY_ALERT then p()_G.PLAY_ALERT=false end;sleep(0.05)end end;local function aC()B(true)c.s.print.set(false)au()aq()parallel.waitForAll(az,aA,aB)O(0)term.clear()term.setCursorPos(1,1)term.setTextColor(colors.white)end;aC()
