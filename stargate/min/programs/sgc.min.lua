require(settings.get("ghu.base").."core/apis/ghu")local a=require("am.core")local b=require("am.ui")local c=peripheral.find("basic_interface")local d=peripheral.find("monitor")local e=require("am.log")if c==nil then error("Could not find Stargate Basic Interface")end;if d==nil then error("Could not find Stargate Dialing Monitor")end;_G.RUNNING=false;_G.CAN_DIAL=false;local f={}local g=nil;local h={}h.allGates={name="sg.allGates",default={},type="table"}h=a.makeSettingWrapper(h)local i=b.Screen(term,{textColor=colors.white,backgroundColor=colors.black})local j=b.Screen(d,{textColor=colors.white,backgroundColor=colors.black})local function k()return _G.CAN_DIAL end;local function l()return _G.RUNNING end;local function m(n)local o=h.allGates.get()for p,address in pairs(o)do if#n==#address.address then local q=true;for r,s in ipairs(address.address)do if s~=n[r]then q=false;break end end;if q then return address end end end;local t="-"for p,s in ipairs(n)do t=t..tostring(s).."-"end;return{id="unknown",name=t,address=address}end;local function u(v)_G.RUNNING=v;if not v then _G.CAN_DIAL=false end end;local function w(x)local y=i:get("termStatus")if y~=nil then y:update(x)end;local z=j:get("dialStatus")if z~=nil then z:update(x)end end;local function A(x,B)local C=i:get("termProgress")local D=false;if C~=nil then if B==nil then C.obj.baseLabel=""C.obj.visible=false;C:update(0)i:render()else C.obj.baseLabel=x;C.obj.visible=true;C:update(B)i:render()end end;local E=j:get("dialProgress")if E~=nil then if B==nil then E.obj.baseLabel=""E.obj.visible=false;E:update(0)j:render()else E.obj.baseLabel=x;E.obj.visible=true;E:update(B)j:render()end end end;local function F(G)c.rotateClockwise(G)while not c.isCurrentSymbol(G)do sleep(1)end end;local function H(I)if I==nil then I=1 end;_G.CAN_DIAL=false;g=nil;w("Resetting Stargate")A("")c.disconnectStargate()if not c.isCurrentSymbol(0)then c.rotateClockwise(-1)if I>0 then sleep(I)end;F(0)end;w("Idle")e.debug("idle")_G.CAN_DIAL=true end;local function J(G)if not k()then return end;F(G)c.raiseChevron()sleep(0.5)c.lowerChevron()end;local function K(address)local L=0;local M=#address.address+1;local N="Dial: "..address.name;e.debug("dial address: "..address.name)w("Dialing")A(N,1)c.disconnectStargate()c.rotateClockwise(-1)sleep(3)if not k()then return end;for p,G in ipairs(address.address)do if k()then J(G)L=L+1;A(N,math.floor(L/M*100))end end;if k()then J(0)A(N,100)end end;local function O(P,Q,R)local address=f[P.id]if address==nil then e.debug("No dial ("..P.id..")")elseif g~=nil then e.debug("Dial already in progress")else g=address;P.fillColor=colors.lightGray;P.disabled=true end end;local function S()local T=i:get("dialFrame")if T~=nil then T:setVisible(true)end;local U=i:get("manualFrame")if U~=nil then U:setVisible(false)end;i:render()end;local function V()local T=i:get("dialFrame")if T~=nil then T:setVisible(false)end;local U=i:get("manualFrame")if U~=nil then U:setVisible(true)end;i:render()end;local function W(X)local Y,Z=i.output.getSize()local _=b.Frame(b.a.TopLeft(),{id="termAddress",width=Y-10,height=Z-7,backgroundColor=colors.black,fillColor=colors.lightGray,fillHorizontal=false,scrollBar=true,padLeft=1,padTop=1})X:add(_)local a0=b.Button(b.a.BottomLeft(),"Dial",{id="termDial",disabled=true,fillColor=colors.lightGray,width=Y-10,backgroundColor=colors.black})a0:addActivateHandler(O)X:add(a0)local a1=b.Button(b.a.BottomRight(),"Exit",{fillColor=colors.red,backgroundColor=colors.black})a1:addActivateHandler(function()u(false)end)X:add(a1)local a2=b.Button(b.a.Right(Z-9),"Reset",{fillColor=colors.yellow,backgroundColor=colors.black,textColor=colors.black})a2:addActivateHandler(function()H()end)X:add(a2)local a3=b.Button(b.a.Right(Z-12),"Manual",{id="manualButton",fillColor=colors.blue,backgroundColor=colors.black,textColor=colors.black})a3:addActivateHandler(function()V()end)X:add(a3)end;local function a4(X)local Y,Z=i.output.getSize()local a5=b.Button(b.a.BottomRight(),"Auto",{id="autoButton",fillColor=colors.blue,backgroundColor=colors.black,textColor=colors.black})a5:addActivateHandler(function()S()end)X:add(a5)end;local function a6(a7)local Y,Z=a7.output.getSize()a7:add(b.Text(b.a.Top(),"Stargate Control",{textColor=colors.cyan}))a7:add(b.Text(b.a.Center(3),"",{id="termStatus",textColor=colors.white}))local a8=b.ProgressBar(b.a.Left(4),{id="termProgress",label="",textColor=colors.white,border=0,showProgress=false,showCount=false,showPercent=true})a8.visible=false;a7:add(a8)local T=b.Frame(b.a.Left(5),{id="dialFrame",width=Y,height=Z-4,backgroundColor=colors.black,fillColor=colors.black,border=0,fillHorizontal=true,scrollBar=false,padLeft=0,padTop=0})a7:add(T)W(T)local U=b.Frame(b.a.Left(5),{id="manualFrame",width=Y,height=Z-4,backgroundColor=colors.black,fillColor=colors.black,border=0,fillHorizontal=true,scrollBar=false,padLeft=0,padTop=0})a7:add(U)a4(U)U:setVisible(false)end;local function a9(a7)local Y,Z=a7.output.getSize()a7:add(b.Text(b.a.Top(),"Stargate Dialer",{textColor=colors.cyan}))a7:add(b.Text(b.a.Center(3),"",{id="dialStatus",textColor=colors.white}))local a8=b.ProgressBar(b.a.Left(4),{id="dialProgress",label="",textColor=colors.white,border=0,showProgress=false,showCount=false,showPercent=true})a8.visible=false;a7:add(a8)local _=b.Frame(b.a.Left(5),{id="dialAddress",width=Y,height=Z-7,backgroundColor=colors.black,fillColor=colors.lightGray,fillHorizontal=false,scrollBar=true,padLeft=1,padTop=1})a7:add(_)local a0=b.Button(b.a.BottomLeft(),"Dial",{id="dialDial",disabled=true,fillColor=colors.lightGray,width=Y,backgroundColor=colors.black})a0:addActivateHandler(O)a7:add(a0)end;local function aa(ab,ac)return ab.name:lower()<ac.name:lower()end;local function ad(ae,X)local af={}for r,address in ipairs(ae)do local Y=X:getWidth()local N="  "..address.name..string.rep(" ",Y-address.name:len()-2)local ag=X.obj.id..address.id;local ah=X:get(ag)local x;if ah==nil then x=b.Text(b.a.Left(r),N,{id=ag,width=X:getWidth()})X.obj:add(x)else x=ah.obj;x.anchor=b.a.Left(r)end;x.label=N;x.backgroundColor=colors.lightGray;x.textColor=colors.black;x.visible=true;af[N]=true end;for p,ai in pairs(X.obj.i)do if af[ai.label]==nil then ai.visible=false end end end;local function aj()local o=h.allGates.get()local ae={}for p,address in pairs(o)do ae[#ae+1]=address end;table.sort(ae,aa)ad(ae,i:get("termAddress"))i:render()ad(ae,j:get("dialAddress"))j:render()end;local function ak(al,t,address)local o=h.allGates.get()o[al]={id=al,name=t,address=address}h.allGates.set(o)end;local function am(al)local o=h.allGates.get()o[al]=nil;h.allGates.set(o)aj()end;local function an()a6(i)a9(j)i:render()j:render()end;local function ao(X,P,ap)e.debug("click ("..X.obj.id.."): "..ap)e.debug(P.obj.id)local Y=X:getWidth()local o=h.allGates.get()local ae={}for p,address in pairs(o)do ae[#ae+1]=address end;table.sort(ae,aa)local address=ae[ap]if address==nil or g~=nil or not k()then P.obj.fillColor=colors.lightGray;P.obj.disabled=true else P.obj.fillColor=colors.green;P.obj.disabled=false end;if address==nil then f[P.obj.id]=nil;return end;f[P.obj.id]=address;for p,ai in pairs(X.obj.i)do local N="  "..address.name..string.rep(" ",Y-address.name:len()-2)if ai.label==N then ai.backgroundColor=colors.black;ai.textColor=colors.green else ai.backgroundColor=colors.lightGray;ai.textColor=colors.black end end end;local function aq(R,ar)if R:find("^stargate_")then e.debug({R,ar})if R=="stargate_chevron_engaged"then w("Chevron "..ar[1].." Engaged: "..ar[2])elseif R=="stargate_outgoing_wormhole"then address=m(ar[1])w("Outgoing: "..address.name)A("")elseif R=="stargate_incoming_wormhole"then address=m(ar[1])w("Incoming: "..address.name)A("")_G.CAN_DIAL=false elseif R=="stargate_disconnected"then A("")w("Idle")_G.CAN_DIAL=true end elseif R=="terminate"then u(false)else i:handle(R,table.unpack(ar))j:handle(R,table.unpack(ar))if R=="ui.frame_click"and ar[1].objId=="termAddress"then ao(i:get("termAddress"),i:get("termDial"),ar[1].y)i:render()elseif R=="ui.frame_touch"and ar[1].objId=="dialAddress"then ao(j:get("dialAddress"),j:get("dialDial"),ar[1].y)j:render()end end end;local function as()while l()do local R,ar=a.cleanEventArgs(os.pullEventRaw())aq(R,ar)end end;local function at()H()while l()do if g~=nil then K(g)g=nil end;sleep(1)end end;local function au()u(true)e.s.print.set(false)an()aj()parallel.waitForAll(as,at)H(0)term.clear()term.setCursorPos(1,1)term.setTextColor(colors.white)end;au()
